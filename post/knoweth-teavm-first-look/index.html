<!DOCTYPE html> <html lang="en"> <head> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title>First Look at TeaVM: Java on the Browser? | Kevin Liu</title> <meta name="author" content="Kevin Liu"/> <meta name="description" content="A young upstart named TeaVM attempts to challenge bloated JavaScript web frameworks. Can it succeed?"/> <meta name="keywords" content="jekyll, jekyll-theme, academic-website, portfolio-website"/> <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha256-DF7Zhf293AJxJNTmh5zhoYYIMs2oXitRfBjY+9L//AY=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"/> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/academicons@1.9.1/css/academicons.min.css" integrity="sha256-i1+4qU2G2860dGGIOJscdC30s9beBXjFfzjWLjBRsBg=" crossorigin="anonymous"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/github.css" media="none" id="highlight_theme_light"/> <link rel="shortcut icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>⚛️</text></svg>"> <link rel="stylesheet" href="/assets/css/main.css"> <link rel="canonical" href="https://kliu.io/post/knoweth-teavm-first-look/"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/native.css" media="none" id="highlight_theme_dark"/> <script src="/assets/js/theme.js"></script> <script src="/assets/js/dark_mode.js"></script> </head> <body class="fixed-top-nav sticky-bottom-footer"> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="https://kliu.io/">Kevin Liu</a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about</a> </li> <li class="nav-item "> <a class="nav-link" href="https://www.icloud.com/sharedalbum/#B0iJtdOXmkYghC" target="_blank" rel="noopener noreferrer">photos</a> </li> <li class="nav-item "> <a class="nav-link" href="/reads">reads</a> </li> <li class="nav-item dropdown "> <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">writes</a> <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdown"> <a class="dropdown-item" href="/blog/">blog</a> <a class="dropdown-item" href="/moments/">moments</a> <a class="dropdown-item" href="/objects/">objects</a> </div> </li> <li class="nav-item "> <a class="nav-link" href="/projects/">projects</a> </li> <div class="toggle-container"> <a id="light-toggle"> <i class="fas fa-moon"></i> <i class="fas fa-sun"></i> </a> </div> </ul> </div> </div> </nav> </header> <div class="container mt-5"> <div class="post"> <header class="post-header"> <h1 class="post-title">First Look at TeaVM: Java on the Browser?</h1> <p class="post-meta">August 4, 2019</p> <p class="post-tags"> <a href="/blog/2019"> <i class="fas fa-calendar fa-sm"></i> 2019 </a>   ·   <a href="/blog/tag/tech"> <i class="fas fa-hashtag fa-sm"></i> tech</a>   <a href="/blog/tag/knoweth"> <i class="fas fa-hashtag fa-sm"></i> knoweth</a>   </p> </header> <article class="post-content"> <p>Recently, as part of work on <a href="https://github.com/knoweth/knoweth" target="_blank" rel="noopener noreferrer">Knoweth</a> (an Anki-esque spaced-repetition flashcard reviewer; see <a href="https://insensitive.co/posts/2019/03/anki-redesign-and-development-part-1/" target="_blank" rel="noopener noreferrer">my friend’s blog</a> for more information), I have been experimenting with some lesser-used web technology: <a href="http://teavm.org" target="_blank" rel="noopener noreferrer">TeaVM</a>, an ahead-of-time compiler that converts Java bytecode to JavaScript or WebAssembly.</p> <p>This technology, to put it mildly, is ridiculously impressive. To be clear, this isn’t “I compiled the entire Java Virtual Machine to WebAssembly; please wait for my hundred-megabyte download” (although <a href="https://www.leaningtech.com/cheerpj/" target="_blank" rel="noopener noreferrer">that also exists</a>); this compiles your Java code straight to JS, only including the minimum standard library required. <code class="language-plaintext highlighter-rouge">System.out.println</code>? More like <code class="language-plaintext highlighter-rouge">console.log</code>. Some more features:</p> <ul> <li>It reimplements a good subset of the Java standard library so it can be compiled to JavaScript</li> <li>Through <a href="http://teavm.org/docs/flavour/templates.html" target="_blank" rel="noopener noreferrer">Flavour</a>, it has a full-on single-page-application/HTML templating framework, supporting REST, routing, and custom components</li> <li>It has a <a href="https://stackoverflow.com/questions/42466164/how-i-deploy-my-libgdx-project-to-html-js-using-teavm" target="_blank" rel="noopener noreferrer">libgdx backend</a> to run libgdx applications on the browser</li> <li>It’s ridiculously lean</li> </ul> <p>So considering the sizable proportion of developers who <a href="https://www.semitwist.com/mirror/node-js-is-cancer.html" target="_blank" rel="noopener noreferrer">hate JavaScript</a> with a burning passion (for entirely understandable reasons), can TeaVM offer a compelling alternative?</p> <h2 id="trying-it-out">Trying it Out</h2> <p>[UPDATE 2019-08-10: This post has been lightly revised due to the <a href="https://www.reddit.com/r/java/comments/cm3oh9/first_look_at_teavm_java_on_the_browser/ew3fksr/" target="_blank" rel="noopener noreferrer">comments of konsoletyper, TeaVM’s developer</a>. One thing not mentioned in this post is how willing the developer is to provide help ;).]</p> <p>Let’s try it out:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ mvn compile
...
[INFO] ------------------------------------------------------------------------
[INFO] BUILD FAILURE
[INFO] ------------------------------------------------------------------------
[INFO] Total time: 5.393 s
[INFO] Finished at: 2019-08-04T19:12:03-04:00
[INFO] Final Memory: 23M/39M
[INFO] ------------------------------------------------------------------------
[ERROR] Failed to execute goal org.teavm:teavm-maven-plugin:0.5.1:compile (default-cli) on project knoweth: Unexpected error occured: ConcurrentModificationException -&gt; [Help 1]
[ERROR]
[ERROR] To see the full stack trace of the errors, re-run Maven with the -e switch.
[ERROR] Re-run Maven using the -X switch to enable full debug logging.
[ERROR]
</code></pre></div></div> <p>(Elided are hours of me trying to figure out how Maven works, since I’ve never used it before. I won’t count that against TeaVM. If you’re stuck, my understanding is that teavm’s maven plugin runs by default in the <code class="language-plaintext highlighter-rouge">package</code> phase? So running <code class="language-plaintext highlighter-rouge">mvn compile</code> actually won’t run it by default.)</p> <p>I’ll save you the <a href="https://github.com/konsoletyper/teavm/issues/363" target="_blank" rel="noopener noreferrer">Googling</a> and just say that TeaVM 0.5.1 (the latest stable release) is incompatible with Java 11, which I am using. The solution is to use their development <code class="language-plaintext highlighter-rouge">0.6.0-dev-*</code> versions from bintray. Fine - it would have been nice if TeaVM had a stable release for Java 11 (and it should be better documented), but it works.</p> <h2 id="rest-client-issues">REST Client Issues</h2> <p>Here is some code that will call a <code class="language-plaintext highlighter-rouge">/login</code> endpoint with a JSON body of <code class="language-plaintext highlighter-rouge">{ "username": "bob", "password": "bob" }</code>:</p> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Path</span><span class="o">(</span><span class="s">""</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">UserService</span> <span class="o">{</span>
    <span class="nd">@Path</span><span class="o">(</span><span class="s">"login"</span><span class="o">)</span>
    <span class="nd">@POST</span>
    <span class="kt">void</span> <span class="nf">login</span><span class="o">(</span><span class="nc">LoginBody</span> <span class="n">body</span><span class="o">);</span>
<span class="o">}</span>

<span class="o">...</span>
<span class="kd">public</span> <span class="nf">UserView</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">UserService</span> <span class="n">r</span> <span class="o">=</span> <span class="nc">RESTClient</span><span class="o">.</span><span class="na">factory</span><span class="o">(</span><span class="nc">UserService</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">createResource</span><span class="o">(</span><span class="s">""</span><span class="o">);</span>
    <span class="nc">BackgroundWorker</span> <span class="n">worker</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BackgroundWorker</span><span class="o">();</span>
    <span class="n">worker</span><span class="o">.</span><span class="na">run</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="c1">// Should make a POST request to /login with JSON body</span>
            <span class="n">r</span><span class="o">.</span><span class="na">login</span><span class="o">(</span><span class="k">new</span> <span class="nc">LoginBody</span><span class="o">(</span><span class="s">"bob"</span><span class="o">,</span> <span class="s">"bob"</span><span class="o">));</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">});</span>
<span class="o">}</span>
</code></pre></div></div> <p><del>Issue #1 is that you <em>need</em> to make the login request from a <code class="language-plaintext highlighter-rouge">BackgroundWorker</code>.</del> In this <em>specific case</em>, you need to make this request from an asynchronous context. In this example, it uses a BackgroundWorker, a class that Flavour uses to run background methods and update bound templates afterward, leveraging TeaVM’s async support. (That’s right: TeaVM added green threads to Java. In JavaScript.) This is not documented on their <a href="http://teavm.org/docs/flavour/rest-client.html" target="_blank" rel="noopener noreferrer">REST client docs</a> (although it is on their <a href="http://teavm.org/docs/flavour/advanced-ui-components.html" target="_blank" rel="noopener noreferrer">advanced UI components page</a> and is explained more on <a href="http://teavm.org/docs/runtime/coroutines.html" target="_blank" rel="noopener noreferrer">their coroutines page</a>); I only figured it out by coming across a chance Google Groups post.</p> <p>The second issue is this one:</p> <p><img src="/images/2019-07-22-knoweth-teavm-first-look/java-exception-thrown.png" alt="fetch request fails with Java exception thrown"></p> <p>An error whose <del>undescriptiveness rivals babel-transpiled asynchronous JavaScript code</del>. (Correction: Babel code is actually worse, since it doesn’t preserve the stack trace, while TeaVM does so.) The core issue is actually <em>not</em> a Java exception; rather, it’s a JavaScript error from within standard library <code class="language-plaintext highlighter-rouge">RequestImpl</code> code, hence why it provides no description of what the error is. The REST client attempts, in 0.6.0-dev-816, to call a JS function that does not exist (<code class="language-plaintext highlighter-rouge">otfri_RequestImpl_send0</code>), and it fails with the JavaScript error <code class="language-plaintext highlighter-rouge">otfri_RequestImpl_send0 is not defined</code>. <del>The only way I’ve been able to fix this is to roll back to Java 8 + TeaVM 0.5.1, which fixes the problem.</del> The underlying problem is that you can’t use unstable TeaVM (0.6.0) with stable Flavour (0.1.0); upgrade Flavour to 0.2.0-dev. (Issue reference: <a href="https://github.com/konsoletyper/teavm/issues/407" target="_blank" rel="noopener noreferrer">#407</a>.)</p> <p>As a whole, there also doesn’t appear to be a way to make low-level HTTP requests (e.g. setting headers) other than by writing JavaScript bindings in Java (which is also woefully underdocumented.)</p> <h2 id="in-summary">In Summary</h2> <p>You may have seen a theme here. TeaVM is incredible technology, but it is unfortunately extremely underdocumented, likely due to having less real-world usage than most frameworks. You will find almost nothing on StackOverflow or blog posts about it; your best recourse is typically reading the source code.</p> <p>I would still recommend you try it out, though! And perhaps file a few issues, or write some documentation. When it works, it is amazing to use.</p> <p>(Disclaimer: this is a <em>first look</em>. If any experienced TeaVM users would like to chime in with corrections or advice, please do so in the comments!)</p> </article> <hr> <div style="text-align: center;"> <p>If you like reading these posts, get new ones via email:</p> <div id="mc_embed_signup"> <form action="https://kliu.us10.list-manage.com/subscribe/post?u=5539e4dff5ee082eef001e612&amp;id=f9f0fa279e&amp;f_id=000b36e2f0" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate> <div id="mc_embed_signup_scroll"> <div class="mc-field-group" style="margin-bottom: 1em"> <input type="email" value="" name="EMAIL" class="required email" id="mce-EMAIL" required placeholder="email address"> <span id="mce-EMAIL-HELPERTEXT" class="helper_text"></span> <input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="button"> </div> <div id="mce-responses" class="clear foot"> <div class="response" id="mce-error-response" style="display:none"></div> <div class="response" id="mce-success-response" style="display:none; margin-bottom: 1em"></div> </div> <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_5539e4dff5ee082eef001e612_f9f0fa279e" tabindex="-1" value=""></div> <div class="optionalParent"> <div class="clear foot"> </div> </div> </div> </form> </div> <script type="text/javascript" src="//s3.amazonaws.com/downloads.mailchimp.com/js/mc-validate.js"></script> <script type="text/javascript">jQuery,window.fnames=new Array,window.ftypes=new Array,fnames[0]="EMAIL",ftypes[0]="email",fnames[1]="FNAME",ftypes[1]="text",fnames[2]="LNAME",ftypes[2]="text",fnames[3]="ADDRESS",ftypes[3]="address",fnames[4]="PHONE",ftypes[4]="phone",fnames[5]="BIRTHDAY",ftypes[5]="birthday";var $mcj=jQuery.noConflict(!0);</script> </div> <div id="disqus_thread"></div> <script type="text/javascript">var disqus_shortname="kevin-liu",disqus_identifier="/post/knoweth-teavm-first-look",disqus_title="First Look at TeaVM: Java on the Browser?";!function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="//"+disqus_shortname+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)}();</script> <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript" target="_blank" rel="noopener noreferrer">comments powered by Disqus.</a> </noscript> </div> </div> <footer class="sticky-bottom mt-5"> <div class="container"> © 2022 Kevin Liu. Licensed under CC BY-SA 4.0. Last updated: October 23, 2022. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.2/dist/umd/popper.min.js" integrity="sha256-l/1pMF/+J4TThfgARS6KwWrk/egwuVvhRzfLAMQ6Ds4=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.min.js" integrity="sha256-SyTu6CwrfOhaznYZPoolVw2rxoY7lKYKQvqbtqN93HI=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.6/dist/medium-zoom.min.js" integrity="sha256-EdPgYcPk/IIrw7FYeuJQexva49pVRZNmt3LculEr7zM=" crossorigin="anonymous"></script> <script src="/assets/js/zoom.js"></script> <script src="/assets/js/common.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script async src="https://www.googletagmanager.com/gtag/js?id=G-KKF0HL5TKT"></script> <script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-KKF0HL5TKT");</script> </body> </html>