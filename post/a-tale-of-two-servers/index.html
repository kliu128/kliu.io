<!DOCTYPE html> <html lang="en"> <head> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title>A Tale of Two Servers | Kevin Liu</title> <meta name="author" content="Kevin Liu"/> <meta name="description" content="Two servers, one IP address. Featuring SNI proxies, SSH, and everyone's favorite service to self-host: mail!"/> <meta name="keywords" content="jekyll, jekyll-theme, academic-website, portfolio-website"/> <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha256-DF7Zhf293AJxJNTmh5zhoYYIMs2oXitRfBjY+9L//AY=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"/> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/academicons@1.9.1/css/academicons.min.css" integrity="sha256-i1+4qU2G2860dGGIOJscdC30s9beBXjFfzjWLjBRsBg=" crossorigin="anonymous"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/github.css" media="none" id="highlight_theme_light"/> <link rel="shortcut icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>⚛️</text></svg>"> <link rel="stylesheet" href="/assets/css/main.css"> <link rel="canonical" href="https://kliu.io/post/a-tale-of-two-servers/"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/native.css" media="none" id="highlight_theme_dark"/> <script src="/assets/js/theme.js"></script> <script src="/assets/js/dark_mode.js"></script> </head> <body class="fixed-top-nav sticky-bottom-footer"> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="https://kliu.io/">Kevin Liu</a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about</a> </li> <li class="nav-item "> <a class="nav-link" href="https://www.icloud.com/sharedalbum/#B0iJtdOXmkYghC" target="_blank" rel="noopener noreferrer">photos</a> </li> <li class="nav-item "> <a class="nav-link" href="/reads">reads</a> </li> <li class="nav-item dropdown "> <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">writes</a> <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdown"> <a class="dropdown-item" href="/blog/">blog</a> <a class="dropdown-item" href="/moments/">moments</a> <a class="dropdown-item" href="/objects/">objects</a> </div> </li> <li class="nav-item "> <a class="nav-link" href="/projects/">projects</a> </li> <div class="toggle-container"> <a id="light-toggle"> <i class="fas fa-moon"></i> <i class="fas fa-sun"></i> </a> </div> </ul> </div> </div> </nav> </header> <div class="container mt-5"> <div class="post"> <header class="post-header"> <h1 class="post-title">A Tale of Two Servers</h1> <p class="post-meta">April 2, 2019</p> <p class="post-tags"> <a href="/blog/2019"> <i class="fas fa-calendar fa-sm"></i> 2019 </a>   ·   <a href="/blog/tag/tech"> <i class="fas fa-hashtag fa-sm"></i> tech</a>   <a href="/blog/tag/homelab"> <i class="fas fa-hashtag fa-sm"></i> homelab</a>   </p> </header> <article class="post-content"> <p>Recently (due to causes unimportant in this blog post), I was tasked with running a self-hosted server in my residence. Now, as a seasoned Linux system administrator (heh), this would normally be a fairly easy task. The server had to run web services, mail, and GitLab, which typically would only necessitate some port forwarding.</p> <p>Complicating things, however, was the fact that I <em>already had</em> a server in my house, which also runs web services, mail, and GitLab. Since residential homes are usually only given one IP address, mine being no exception, this meant I had to find some way to host both servers on one IP address.</p> <p>Here’s how I did it!</p> <h2 id="web---port-80-443">Web - Port 80, 443</h2> <p>Web servers are typically pretty easy to proxy. Set up <code class="language-plaintext highlighter-rouge">nginx</code> and a few virtual hosts, and voilá.</p> <p>Unfortunately, both servers (hosting <code class="language-plaintext highlighter-rouge">potatofrom.space</code> and an unnamed sister site<sup id="fnref:1" role="doc-noteref"><a href="#fn:1" class="footnote" rel="footnote">1</a></sup>) use HTTPS with Let’s Encrypt. With a reverse proxy setup like <code class="language-plaintext highlighter-rouge">nginx</code>, <code class="language-plaintext highlighter-rouge">nginx</code> would have to manage all TLS certificates for both sites, which is not what I wanted, since I wanted both servers to maintain separate configurations. (It is a distinct possibility that I might end up giving back or decommissioning the other server at some point.) This sort of setup would also require manual updates whenever I added a subdomain on either <code class="language-plaintext highlighter-rouge">potatofrom.space</code> or the other site.</p> <p>I had some ridiculous ideas at first, namely to use a Raspberry Pi or other device with nginx and two wildcard Let’s Encrypt certificates (<code class="language-plaintext highlighter-rouge">*.potatofrom.space</code>, <code class="language-plaintext highlighter-rouge">*.&lt;redacted&gt;</code>) for simpler proxying. But that too seemed annoying.</p> <p>Then came <a href="https://github.com/dlundquist/sniproxy" target="_blank" rel="noopener noreferrer">SNIPROXY</a>!</p> <p>If you have never had the good fortune of coming across this incredible piece of software, it lets you proxy TLS, without providing certificates. If you’re like me, this blew your mind.</p> <p>Here’s how it works:</p> <ul> <li>To support hosting multiple (sub)domains on one IP with different certificates, TLS has an extension called Server Name Indication (SNI), where the client sends the name of the server they want to connect to in their handshake.</li> <li>The SNI message is <em>unencrypted</em>. It happens before setting up encryption!</li> </ul> <p>(This design also leads to <a href="https://blog.cloudflare.com/esni/" target="_blank" rel="noopener noreferrer">some privacy issues</a>.)</p> <p><code class="language-plaintext highlighter-rouge">sniproxy</code> hence looks at that first SNI message, then sets up the connection with the backend server <em>without touching encryption at all</em>. After that first handshake, it merely relays encrypted ciphertext. The upshot of this is that each of my servers can keep on managing their own Let’s Encrypt certificates, minimizing workflow disruptions. It also makes <code class="language-plaintext highlighter-rouge">sniproxy</code> configuration much simpler. Here’s my config right now:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>error_log {
  # Log to the daemon syslog facility
  syslog daemon
}
# Global access log for all listeners
access_log {
  # Log to the daemon syslog facility
  syslog daemon
}
listen 80 {
  proto http
}
listen 443 {
  proto tls
}
table {
  ^((.+\.)|())potatofrom\.space$ 10.99.0.1
  ^((.+\.)|())redacted\.com$ 192.168.1.3
}
</code></pre></div></div> <p>Wonderfully simple.</p> <h2 id="gitlab---port-22">GitLab - Port 22</h2> <p>A self-hosted GitLab instance generally runs an SSH daemon port 22, so that users can clone repositories through SSH.</p> <p>Unfortunately, <a href="https://serverfault.com/questions/34552/is-there-a-name-based-virtual-host-ssh-reverse-proxy" target="_blank" rel="noopener noreferrer">it appears SSH does not send the hostname as part of the protocol</a>, so hosting multiple SSH servers on the same port is impossible.</p> <p>After some consideration, I decided to just turn off SSH for https://gitlab.potatofrom.space, since I’m the only one using it. I switched instead to cloning through HTTPS using personal access tokens.</p> <h2 id="mail---ports-25-110-143-465-587-993-995-oh-my">Mail - Ports 25, 110, 143, 465, 587, 993, 995, Oh My!</h2> <p>Mail servers use… a lot of ports. Thankfully, only some of them are really necessary.</p> <ul> <li> <strong>25 (SMTP)</strong>: This port <em>must</em> be publicly-accessible by other mail servers so they can deliver mail to you. This port is <em>not configurable</em>, no matter how much <a href="https://tools.ietf.org/html/rfc6186" target="_blank" rel="noopener noreferrer">RFC 6186</a> might tell you otherwise.<sup id="fnref:2" role="doc-noteref"><a href="#fn:2" class="footnote" rel="footnote">2</a></sup> </li> <li> <strong>587 (SMTP)</strong>: Mail submission for email clients. This has to be different from port 25, since <a href="https://forums.att.com/t5/AT-T-Internet-Features/Unblock-port-25/td-p/4343420" target="_blank" rel="noopener noreferrer">a</a> <a href="https://forums.verizon.com/t5/Verizon-net-Email/Verizon-is-blocking-TCP-port-25/td-p/851629" target="_blank" rel="noopener noreferrer">lot</a> <a href="https://community.cisco.com/t5/routing/block-outbound-port-25/td-p/1198091" target="_blank" rel="noopener noreferrer">of</a> <a href="https://www.xfinity.com/support/articles/email-port-25-no-longer-supported" target="_blank" rel="noopener noreferrer">internet service providers</a> block port 25 for users. You can change it from 587, though; you just need to reconfigure your mail clients if so.</li> <li> <strong>143 (IMAP)</strong>: Modern mail retrieval for mail clients.<sup id="fnref:3" role="doc-noteref"><a href="#fn:3" class="footnote" rel="footnote">3</a></sup> Again, this port can be changed, but you will need to reconfigure mail clients.</li> </ul> <p>Resolving the conflict on ports 143 and 587 was simple enough: I forwarded 143 and 587 to the new server and forwarded 10143 and 10587 to my old one. Port 25 was annoying, though.</p> <p>In the end, I figured the best way to do it would be to have the new server forward any mail it got for <code class="language-plaintext highlighter-rouge">potatofrom.space</code> to my personal mailserver. This way, the new server would be the sole public-facing presence on my IP, but I would still be able to receive mail on both servers. Since the new server uses <a href="https://mailu.io" target="_blank" rel="noopener noreferrer">Mailu</a>, which has a “relayed domains” feature, I figured this would be fairly easy.</p> <p>As with all things mail, it was not.</p> <p>To all the poor souls (or future mes) facing the same problem, here’s the magic incantation:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>smtpd_client_restrictions =
  permit_mynetworks,
  reject_non_fqdn_sender,
  reject_unknown_sender_domain,
  reject_unknown_recipient_domain,
  permit
</code></pre></div></div> <p>In <code class="language-plaintext highlighter-rouge">postfix.cf</code>. Note the <a href="https://github.com/Mailu/Mailu/blob/94e42c9b520557387520622306af0a23458a0ccb/core/postfix/conf/main.cf#L93" target="_blank" rel="noopener noreferrer">lack of <code class="language-plaintext highlighter-rouge">reject_unverified_recipient</code></a>. This stopped Mailu from preemptively rejecting the mail <em>even though</em> I had explicitly configured it for relaying.</p> <p>Then, I added the Mailu server’s IP address as a <code class="language-plaintext highlighter-rouge">TrustedHosts</code> on my own mailserver, so that it wouldn’t get tilted and reject what it was receiving.</p> <p>And voilá! A few server reconfigurations on my side, and both servers were now working.</p> <h2 id="conclusion">Conclusion</h2> <p>Should you do this? Probably not. <a href="https://www.verizon.com/business" target="_blank" rel="noopener noreferrer">Just get another IP address</a>. Or, uh, don’t have two servers?</p> <p>If, however, you are like me, and want the lowest-cost, least-disruption solution… well, here you are.</p> <div class="footnotes" role="doc-endnotes"> <ol> <li id="fn:1" role="doc-endnote"> <p>Yes, I know basically anyone could find out what the other server is, considering I literally said it’s on the same IP address as the website you’re looking at now. Still, for confidentiality’s sake I’d rather not say. <a href="#fnref:1" class="reversefootnote" role="doc-backlink">↩</a></p> </li> <li id="fn:2" role="doc-endnote"> <p>I haven’t read RFC 6186 too closely, but I <em>think</em> it’s usage of the <code class="language-plaintext highlighter-rouge">_submission</code> SRV record may only be for mail user agents to follow, not other mail servers. In any case, I wouldn’t want to rely on it when forty years of backwards compatibility argue against it. <a href="#fnref:2" class="reversefootnote" role="doc-backlink">↩</a></p> </li> <li id="fn:3" role="doc-endnote"> <p>Please don’t use POP3. <a href="#fnref:3" class="reversefootnote" role="doc-backlink">↩</a></p> </li> </ol> </div> </article> <hr> <div style="text-align: center;"> <p>If you like reading these posts, get new ones via email:</p> <div id="mc_embed_signup"> <form action="https://kliu.us10.list-manage.com/subscribe/post?u=5539e4dff5ee082eef001e612&amp;id=f9f0fa279e&amp;f_id=000b36e2f0" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate> <div id="mc_embed_signup_scroll"> <div class="mc-field-group" style="margin-bottom: 1em"> <input type="email" value="" name="EMAIL" class="required email" id="mce-EMAIL" required placeholder="email address"> <span id="mce-EMAIL-HELPERTEXT" class="helper_text"></span> <input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="button"> </div> <div id="mce-responses" class="clear foot"> <div class="response" id="mce-error-response" style="display:none"></div> <div class="response" id="mce-success-response" style="display:none; margin-bottom: 1em"></div> </div> <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_5539e4dff5ee082eef001e612_f9f0fa279e" tabindex="-1" value=""></div> <div class="optionalParent"> <div class="clear foot"> </div> </div> </div> </form> </div> <script type="text/javascript" src="//s3.amazonaws.com/downloads.mailchimp.com/js/mc-validate.js"></script> <script type="text/javascript">jQuery,window.fnames=new Array,window.ftypes=new Array,fnames[0]="EMAIL",ftypes[0]="email",fnames[1]="FNAME",ftypes[1]="text",fnames[2]="LNAME",ftypes[2]="text",fnames[3]="ADDRESS",ftypes[3]="address",fnames[4]="PHONE",ftypes[4]="phone",fnames[5]="BIRTHDAY",ftypes[5]="birthday";var $mcj=jQuery.noConflict(!0);</script> </div> <div id="disqus_thread"></div> <script type="text/javascript">var disqus_shortname="kevin-liu",disqus_identifier="/post/a-tale-of-two-servers",disqus_title="A Tale of Two Servers";!function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="//"+disqus_shortname+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)}();</script> <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript" target="_blank" rel="noopener noreferrer">comments powered by Disqus.</a> </noscript> </div> </div> <footer class="sticky-bottom mt-5"> <div class="container"> © 2022 Kevin Liu. Licensed under CC BY-SA 4.0. Last updated: October 23, 2022. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.2/dist/umd/popper.min.js" integrity="sha256-l/1pMF/+J4TThfgARS6KwWrk/egwuVvhRzfLAMQ6Ds4=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.min.js" integrity="sha256-SyTu6CwrfOhaznYZPoolVw2rxoY7lKYKQvqbtqN93HI=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.6/dist/medium-zoom.min.js" integrity="sha256-EdPgYcPk/IIrw7FYeuJQexva49pVRZNmt3LculEr7zM=" crossorigin="anonymous"></script> <script src="/assets/js/zoom.js"></script> <script src="/assets/js/common.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script async src="https://www.googletagmanager.com/gtag/js?id=G-KKF0HL5TKT"></script> <script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-KKF0HL5TKT");</script> </body> </html>