<!DOCTYPE html> <html lang="en"> <head> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title>Using a Yubikey as a touchless, magic unlock key for Linux | Kevin Liu</title> <meta name="author" content="Kevin Liu"/> <meta name="description" content="Yubikeys are great for security, but their benefits decrease somewhat when you leave them in your computer unattended. I also have login passwords that are way too long. How to solve these problems? Use a Yubikey to unlock your computer!"/> <meta name="keywords" content="jekyll, jekyll-theme, academic-website, portfolio-website"/> <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha256-DF7Zhf293AJxJNTmh5zhoYYIMs2oXitRfBjY+9L//AY=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"/> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/academicons@1.9.1/css/academicons.min.css" integrity="sha256-i1+4qU2G2860dGGIOJscdC30s9beBXjFfzjWLjBRsBg=" crossorigin="anonymous"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/github.css" media="none" id="highlight_theme_light"/> <link rel="shortcut icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>⚛️</text></svg>"> <link rel="stylesheet" href="/assets/css/main.css"> <link rel="canonical" href="https://kliu.io/post/yubico-magic-unlock/"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/native.css" media="none" id="highlight_theme_dark"/> <script src="/assets/js/theme.js"></script> <script src="/assets/js/dark_mode.js"></script> </head> <body class="fixed-top-nav sticky-bottom-footer"> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="https://kliu.io/">Kevin Liu</a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about</a> </li> <li class="nav-item "> <a class="nav-link" href="https://www.icloud.com/sharedalbum/#B0iJtdOXmkYghC" target="_blank" rel="noopener noreferrer">photos</a> </li> <li class="nav-item "> <a class="nav-link" href="/reads">reads</a> </li> <li class="nav-item dropdown "> <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">writes</a> <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdown"> <a class="dropdown-item" href="/blog/">blog</a> <a class="dropdown-item" href="/moments/">moments</a> <a class="dropdown-item" href="/objects/">objects</a> </div> </li> <li class="nav-item "> <a class="nav-link" href="/projects/">projects</a> </li> <div class="toggle-container"> <a id="light-toggle"> <i class="fas fa-moon"></i> <i class="fas fa-sun"></i> </a> </div> </ul> </div> </div> </nav> </header> <div class="container mt-5"> <div class="post"> <header class="post-header"> <h1 class="post-title">Using a Yubikey as a touchless, magic unlock key for Linux</h1> <p class="post-meta">August 16, 2020</p> <p class="post-tags"> <a href="/blog/2020"> <i class="fas fa-calendar fa-sm"></i> 2020 </a> </p> </header> <article class="post-content"> <p>Yubikeys are great for security, but their benefits decrease somewhat when you leave them in your computer unattended.<sup id="fnref:3" role="doc-noteref"><a href="#fn:3" class="footnote" rel="footnote">1</a></sup> I unfortunately have a habit of forgetting my key when I walk away from the computer. I also have login passwords that are way too long and easy to typo.</p> <p>Thankfully, there’s a way to solve both of these problems: use a Yubikey to unlock your computer when you put it in and lock your computer when you remove it!</p> <h2 id="prior-art">Prior art</h2> <p>The first example I remember seeing of this concept years ago was <a href="https://www.predator-usb.com/predator/en/index.php" target="_blank" rel="noopener noreferrer">Predator</a>, Windows software (with a delightfully retro website) that locks your computer when you remove a special USB drive. Similar examples for Linux include <a href="https://wiki.debian.org/pamusb" target="_blank" rel="noopener noreferrer">pamusb</a>, which allows you to login using Linux’s PAM by inserting a specially-formatted USB stick.</p> <p>Of course, nowadays most people use Yubikeys to accomplish this, and Yubico has <a href="https://developers.yubico.com/yubico-pam/Authentication_Using_Challenge-Response.html" target="_blank" rel="noopener noreferrer">convenient guides</a> on how to accomplish this very task. However, I wanted to make it <em>touchless</em> – that is, I wanted to be able to plug in my Yubikey and instantly unlock my laptop, without clicking through logins or touching the Yubikey button. Upon removal, I wanted to instantly lock my computer.</p> <h2 id="making-it-contactless">Making it contactless<sup id="fnref:1" role="doc-noteref"><a href="#fn:1" class="footnote" rel="footnote">2</a></sup> </h2> <p>There are some guides on how to do this online (unlock when you plug in, lock when you remove), but unfortunately most of them fall prey to the problem described in <a href="https://medium.com/@d0znpp/how-to-sacrifice-security-using-a-public-yubikey-linux-guides-c823c4c6e2" target="_blank" rel="noopener noreferrer">this article</a>. A lot of them use udev to detect when the Yubikey is plugged in, but they don’t actually authenticate the key beyond checking its vendor ID, model ID, and sometimes serial number, which all can <a href="https://forums.anandtech.com/threads/changing-creating-a-custom-serial-id-on-a-flash-drive-low-level-blocks.2099116/" target="_blank" rel="noopener noreferrer">easily be faked</a>.</p> <p>To provide actual security, most official guides use either <code class="language-plaintext highlighter-rouge">pam_u2f</code> (which authenticates a Yubikey through the <a href="https://en.wikipedia.org/wiki/Universal_2nd_Factor" target="_blank" rel="noopener noreferrer">U2F protocol</a>) or <code class="language-plaintext highlighter-rouge">pam_yubico</code> (which uses either online validation through YubiCloud or offline validation through a challenge-response protocol). The U2F method requires a tap on the Yubikey, while the challenge-response process can be done without user interaction, so I went with the latter. I set up traditional Yubikey authentication using <a href="https://support.system76.com/articles/yubikey-login/" target="_blank" rel="noopener noreferrer">this great guide from System76</a>.</p> <p>However, I still needed some way to test the challenge-response for success when I plugged in the key. Usually, <code class="language-plaintext highlighter-rouge">pam_yubico</code> is run when you login or unlock your computer (i.e. when pressing the enter key on the lockscreen). But I didn’t want <em>any</em> clicks, so I needed a way to run it without interaction.</p> <p>Enter <code class="language-plaintext highlighter-rouge">udev</code> (again) and <code class="language-plaintext highlighter-rouge">pamtester</code>!</p> <p>Here’s the udev rules I included:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kevin@you:~ » cat /etc/udev/rules.d/yubikey.rules
ACTION::"remove", ENV{DEVTYPE}::"usb_device", ENV{PRODUCT}::"1050/407*", RUN+:"/usr/local/sbin/ykunlock.sh lock"
ACTION::"add", ENV{DEVTYPE}::"usb_device", ENV{ID_BUS}::"usb", ENV{PRODUCT}::"1050/407*", RUN+:"/usr/local/sbin/ykunlock.sh unlock"
</code></pre></div></div> <p>These rules effectively call a script when inserting and removing the key, so I can trigger any action from the script. Note that the script <strong>should not immediately unlock the computer</strong>, to avoid the security issues mentioned earlier.</p> <p>To actually test the challenge-response from the Yubikey on inserting, I decided to use <a href="http://pamtester.sourceforge.net/" target="_blank" rel="noopener noreferrer">pamtester</a>, a simple utility that pretends to trigger a PAM authentication from the command line. Since <code class="language-plaintext highlighter-rouge">pam_yubico</code> is installed, this will naturally test the challenge-response if a Yubikey is plugged in.</p> <p>Here’s the final script:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>
<span class="nb">exec </span>1&gt; <span class="o">&gt;(</span>logger <span class="nt">-s</span> <span class="nt">-t</span> <span class="s2">"</span><span class="si">$(</span><span class="nb">basename</span> <span class="s2">"</span><span class="nv">$0</span><span class="s2">"</span><span class="si">)</span><span class="s2">"</span><span class="o">)</span> 2&gt;&amp;1
<span class="nb">echo</span> <span class="s2">"RUN"</span>
<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span> : <span class="s2">"lock"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
        </span>pkill <span class="nt">-USR1</span> swayidle
<span class="k">else</span>
        <span class="c"># unlock</span>
        <span class="k">if </span><span class="nb">echo</span> <span class="s2">""</span> | pamtester login kevin authenticate<span class="p">;</span> <span class="k">then</span>
                <span class="c"># PAM login successful</span>
                <span class="c"># kill locker</span>
                <span class="nb">kill</span> <span class="nt">-KILL</span> <span class="si">$(</span>pgrep swaylock<span class="si">)</span>
                ps aux | <span class="nb">grep </span>swaylock
                <span class="c"># turn on displays</span>
                SWAYSOCK:<span class="si">$(</span><span class="nb">ls</span> /run/user/1000/sway-ipc.<span class="k">*</span>.sock<span class="si">)</span> swaymsg <span class="s2">"output * dpms on"</span>
        <span class="k">fi
fi
</span><span class="nb">exit </span>0
</code></pre></div></div> <ul> <li>On lock, it immediately locks my desktop (by sending a SIGUSR1 to swayidle, the program that manages locking on the Sway window manager)</li> <li>On unlock, it first sees if it can authenticate using pamtester without interaction (when no Yubikey is inserted or if the key is invalid, pamtester asks for a password). If it can, it kills the lockscreen and turns on all displays using Sway WM protocols.</li> </ul> <p>The final result is amazingly convenient, and has successfully made me remember to pull out my Yubikey when leaving my computer unattended more than once<sup id="fnref:2" role="doc-noteref"><a href="#fn:2" class="footnote" rel="footnote">3</a></sup>! Mission success.</p> <div class="footnotes" role="doc-endnotes"> <ol> <li id="fn:3" role="doc-endnote"> <p>I’ve significantly downgraded this statement in severity after some excellent comments on Hacker News have pointed out that (1) <a href="https://news.ycombinator.com/item?id:24192390" target="_blank" rel="noopener noreferrer">stealing a Yubikey is incredibly unlikely unless you’re a person of interest</a>; (2) <a href="https://news.ycombinator.com/item?id:24192138" target="_blank" rel="noopener noreferrer">even if you have the Yubikey, you still can’t directly extract e.g. a private key</a>; and (3) a <a href="https://news.ycombinator.com/item?id:24190313" target="_blank" rel="noopener noreferrer">Yubikey protects against SSH/GPG fraud because it can require a PIN and lock out over time</a>. Case in point, Yubikeys are good. I’d argue that it’s still not good to have your key stolen (e.g. perhaps if you’re targeted by a government/<a href="https://news.ycombinator.com/item?id:24194081" target="_blank" rel="noopener noreferrer">industrial espionage</a>, or the malicious significant other attack, where they know your password and can steal your key for 2FA if unattended), but I see that it’s not as much of a risk as I originally thought. <a href="#fnref:3" class="reversefootnote" role="doc-backlink">↩</a></p> </li> <li id="fn:1" role="doc-endnote"> <p>You might call it Yubikey: Coronavirus Edition. <a href="#fnref:1" class="reversefootnote" role="doc-backlink">↩</a></p> </li> <li id="fn:2" role="doc-endnote"> <p>Yes, yes, I know there’s not too much of a danger because we’re all stuck at home right now. But who knows – maybe this will be helpful when we <em>eventually</em> get back on campus. <a href="#fnref:2" class="reversefootnote" role="doc-backlink">↩</a></p> </li> </ol> </div> </article> <hr> <div style="text-align: center;"> <p>If you like reading these posts, get new ones via email:</p> <div id="mc_embed_signup"> <form action="https://kliu.us10.list-manage.com/subscribe/post?u=5539e4dff5ee082eef001e612&amp;id=f9f0fa279e&amp;f_id=000b36e2f0" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate> <div id="mc_embed_signup_scroll"> <div class="mc-field-group" style="margin-bottom: 1em"> <input type="email" value="" name="EMAIL" class="required email" id="mce-EMAIL" required placeholder="email address"> <span id="mce-EMAIL-HELPERTEXT" class="helper_text"></span> <input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="button"> </div> <div id="mce-responses" class="clear foot"> <div class="response" id="mce-error-response" style="display:none"></div> <div class="response" id="mce-success-response" style="display:none; margin-bottom: 1em"></div> </div> <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_5539e4dff5ee082eef001e612_f9f0fa279e" tabindex="-1" value=""></div> <div class="optionalParent"> <div class="clear foot"> </div> </div> </div> </form> </div> <script type="text/javascript" src="//s3.amazonaws.com/downloads.mailchimp.com/js/mc-validate.js"></script> <script type="text/javascript">jQuery,window.fnames=new Array,window.ftypes=new Array,fnames[0]="EMAIL",ftypes[0]="email",fnames[1]="FNAME",ftypes[1]="text",fnames[2]="LNAME",ftypes[2]="text",fnames[3]="ADDRESS",ftypes[3]="address",fnames[4]="PHONE",ftypes[4]="phone",fnames[5]="BIRTHDAY",ftypes[5]="birthday";var $mcj=jQuery.noConflict(!0);</script> </div> <div id="disqus_thread"></div> <script type="text/javascript">var disqus_shortname="kevin-liu",disqus_identifier="/post/yubico-magic-unlock",disqus_title="Using a Yubikey as a touchless, magic unlock key for Linux";!function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="//"+disqus_shortname+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)}();</script> <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript" target="_blank" rel="noopener noreferrer">comments powered by Disqus.</a> </noscript> </div> </div> <footer class="sticky-bottom mt-5"> <div class="container"> © 2022 Kevin Liu. Licensed under CC BY-SA 4.0. Last updated: October 23, 2022. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.2/dist/umd/popper.min.js" integrity="sha256-l/1pMF/+J4TThfgARS6KwWrk/egwuVvhRzfLAMQ6Ds4=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.min.js" integrity="sha256-SyTu6CwrfOhaznYZPoolVw2rxoY7lKYKQvqbtqN93HI=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.6/dist/medium-zoom.min.js" integrity="sha256-EdPgYcPk/IIrw7FYeuJQexva49pVRZNmt3LculEr7zM=" crossorigin="anonymous"></script> <script src="/assets/js/zoom.js"></script> <script src="/assets/js/common.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script async src="https://www.googletagmanager.com/gtag/js?id=G-KKF0HL5TKT"></script> <script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-KKF0HL5TKT");</script> </body> </html>