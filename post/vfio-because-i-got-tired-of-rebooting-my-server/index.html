<!DOCTYPE html> <html lang="en"> <head> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title>VFIO, Because I Got Tired of Rebooting My Server | Kevin Liu</title> <meta name="author" content="Kevin Liu"/> <meta name="description" content="An adventure on VFIO escapades in Proxmox Linux"/> <meta name="keywords" content="jekyll, jekyll-theme, academic-website, portfolio-website"/> <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha256-DF7Zhf293AJxJNTmh5zhoYYIMs2oXitRfBjY+9L//AY=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"/> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/academicons@1.9.1/css/academicons.min.css" integrity="sha256-i1+4qU2G2860dGGIOJscdC30s9beBXjFfzjWLjBRsBg=" crossorigin="anonymous"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/github.css" media="none" id="highlight_theme_light"/> <link rel="shortcut icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>⚛️</text></svg>"> <link rel="stylesheet" href="/assets/css/main.css"> <link rel="canonical" href="https://kliu.io/post/vfio-because-i-got-tired-of-rebooting-my-server/"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/native.css" media="none" id="highlight_theme_dark"/> <script src="/assets/js/theme.js"></script> <script src="/assets/js/dark_mode.js"></script> </head> <body class="fixed-top-nav sticky-bottom-footer"> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="https://kliu.io/">Kevin Liu</a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about</a> </li> <li class="nav-item "> <a class="nav-link" href="https://www.icloud.com/sharedalbum/#B0iJtdOXmkYghC" target="_blank" rel="noopener noreferrer">photos</a> </li> <li class="nav-item "> <a class="nav-link" href="/reads">reads</a> </li> <li class="nav-item dropdown "> <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">writes</a> <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdown"> <a class="dropdown-item" href="/blog/">blog</a> <a class="dropdown-item" href="/moments/">moments</a> <a class="dropdown-item" href="/objects/">objects</a> </div> </li> <li class="nav-item "> <a class="nav-link" href="/projects/">projects</a> </li> <div class="toggle-container"> <a id="light-toggle"> <i class="fas fa-moon"></i> <i class="fas fa-sun"></i> </a> </div> </ul> </div> </div> </nav> </header> <div class="container mt-5"> <div class="post"> <header class="post-header"> <h1 class="post-title">VFIO, Because I Got Tired of Rebooting My Server</h1> <p class="post-meta">February 18, 2017</p> <p class="post-tags"> <a href="/blog/2017"> <i class="fas fa-calendar fa-sm"></i> 2017 </a>   ·   <a href="/blog/tag/vfio"> <i class="fas fa-hashtag fa-sm"></i> vfio</a>   <a href="/blog/tag/tech"> <i class="fas fa-hashtag fa-sm"></i> tech</a>   <a href="/blog/tag/homelab"> <i class="fas fa-hashtag fa-sm"></i> homelab</a>   </p> </header> <article class="post-content"> <p>Hi! First post. (I’m not sure if anyone will actually read this but ¯\_(ツ)_/¯. I thought that writing down how I set up VFIO would be helpful, both for me in the future and for anyone else who wants to try the same thing.)</p> <h2 id="prelude">Prelude</h2> <p>So, at home I had an Arch Linux desktop running a bunch of Docker containers. It acted both as my main computer for tinkering and my server, which is not a good combination for stability or security. Every time I tried Wayland on KDE and my computer locked up, every time I tried a new glitchy kernel, I’d have to reboot the whole computer, taking down my server while I was at it. Unfortunately, I couldn’t have my server on a different computer, because I am a broke high school student.</p> <p>So I decided to try something different—VFIO! Virtual Function I/O, aka virtualizing your main computer while passing through the host graphics card to the virtual machine. Normally this is done with a Windows guest on a Linux host, so one can run Linux for normal applications and then play games using the beefy graphics card. However, I wanted something a little different: I wanted to run my Arch desktop in the virtual machine with the graphics card, and have the server in another.</p> <h2 id="specifications">Specifications</h2> <p>Here are the important specs of my desktop-turned-VFIO-host:</p> <ul> <li> <strong>CPU</strong>: i7-4820k (it supports Intel VT-d and also having a model that supports IOMMU interrupt remapping is important, I think; I just got lucky and happened to have one that does)</li> <li> <strong>Motherboard</strong>: Gigabyte GA-X79-UP4</li> <li> <strong>RAM</strong>: 16 GB non-ECC DDR3 (not ideal, probably)</li> <li> <strong>SSD</strong>: Samsung 840 EVO 256GB (super sucky)</li> <li> <strong>GPU (desktop guest)</strong>: MSI GTX 770 Twin Frozr 2 GB (sort of out of date now)</li> <li> <strong>GPU (host)</strong>: This sucky ATI Radeon X300 or something, stolen from an old Dell Inspiron from 2005</li> <li>(a bunch of other stuff that isn’t really important)</li> </ul> <p>As you can tell, this isn’t the most high end setup, but still fairly formidable, I think.</p> <p>Now, you might be wondering, “why the two dedicated GPUs? even if one is sucky?” Well, the host OS needs a GPU for itself to display the UEFI bootup and console output, and the i7-4820k unfortunately does not have an integrated GPU. There are ways using only one GPU, apparently, but ¯\_(ツ)_/¯.</p> <p>And here’s the software setup:</p> <ul> <li> <strong>Host OS</strong>: Proxmox VE 4.4</li> <li> <strong>Desktop Guest OS</strong>: Arch Linux</li> <li> <strong>Server Guest OS</strong>: Ubuntu Server 16.04</li> </ul> <h2 id="configuration">Configuration</h2> <p>After installing Proxmox on the SSD, I first resized the root partition from ~60GB to ~20 GB to give me more room for the VMs. (Actually, I did this later, and it was a pain in the butt. Do it now.)</p> <p>Then I created the server VM—the easy part, since there’s no GPU passthrough to screw around with. I made a UEFI VM and passed through a few block devices, running <code class="language-plaintext highlighter-rouge">qm set &lt;vm-id&gt; -virtio&lt;0-4&gt; /dev/disk/blahblah</code> as detailed <a href="http://blog.imnotacyb.org/disk-passthrough-in-proxmox/" target="_blank" rel="noopener noreferrer">here</a>.</p> <p>The desktop VM was quite a bit more complicated. I wanted it to also be UEFI using OVMF, so I had to first <a href="https://vfio.blogspot.com/2014/08/does-my-graphics-card-rom-support-efi.html" target="_blank" rel="noopener noreferrer">make sure that my GPU ROM supported UEFI</a>. …And it didn’t (MSI, man, such a slacker), so I had to google for some sketchy UEFI-supporing ROM for my card and flash it.</p> <p>Then I pretty much followed <a href="https://pve.proxmox.com/wiki/Pci_passthrough" target="_blank" rel="noopener noreferrer">Proxmox’s PCI passthrough guide to the letter</a>, passing through the GPU using OVMF and PCI-Express. To pass through my USB devices, I tried futilely to pass through each individual one, but it turns out that there’s a limit of 5 USB devices that can be passed through and passing through hubs doesn’t work for some reason. So I just passed through the entire USB chipset, which seems to work fine. I also passed through the audio chipset for audio.</p> <p>Moral of the story: To get something in a VM, PCI passthrough does the trick every time.</p> <h2 id="problems">Problems</h2> <p>VFIO is not exactly known for its ease of use and simplicity.</p> <ul> <li>Graphics output did display the UEFI boot logo on my guest GPU (yes!), but when I tried to boot into any Linux installation, it lost all signal unless I disabled kernel mode setting. Turns out there’s a bug in nouveau where kernel mode setting fails unless you have <code class="language-plaintext highlighter-rouge">nouveau.config:NvForcePost:1</code> on the kernel command line. (At least that works for me; apparently the problem persists for many others.)</li> <li>Rebooting the guest OS makes the GPU screwy, so that I have to reboot the entire system to fix it. Linux 4.9 works pretty well, but sometimes nouveau logs a bunch of <code class="language-plaintext highlighter-rouge">TRAP</code>s and errors in dmesg on reboot? Linux 4.10-rc5 seems to break rebooting completely, to the point where not even the UEFI boot logo shows up. TTYs also seem broken. Not sure if that’s just because 4.10’s still in rc or because of VFIO.</li> <li>Audio seems to glitch occasionally. Not a big deal, really; it seems to happen in moments of high CPU load. I’m also not sure if it’s PulseAudio’s fault or PCI passthrough’s.</li> </ul> <p>Overall though, I’m quite pleased with the results! If nothing else, it was fun to set up and satisfying to use. Hopefully this guide helps you avoid some of the headaches I encountered if you decide to try the same thing.</p> <h2 id="update-2017-02-11">Update (2017-02-11)</h2> <p>After a while of usage, I encountered another problem in dmesg:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Uhhuh. NMI received for unknown reason 0a on CPU 0.
Do you have a strange power saving mode enabled?
Dazed and confused, but trying to continue
</code></pre></div></div> <p>A bit weird, don’t you think? This seems to coincide with a notable reduction in performance. After a bunch of googling, I changed the <code class="language-plaintext highlighter-rouge">machine</code> parameter in <code class="language-plaintext highlighter-rouge">vmid.conf</code> to use <code class="language-plaintext highlighter-rouge">i440fx</code> instead of <code class="language-plaintext highlighter-rouge">q35</code>. A good summary of the differences is <a href="https://www.reddit.com/r/VFIO/comments/5ireij/differencesbenefits_between_i440fx_and_q35/dbb2e01/" target="_blank" rel="noopener noreferrer">here</a>. Since <code class="language-plaintext highlighter-rouge">i440fx</code> doesn’t have PCI-E support, I also had to remove the <code class="language-plaintext highlighter-rouge">pcie:1</code> parameter from my <code class="language-plaintext highlighter-rouge">hostpciX</code> entries. (I guess it does some sort of frankenstein PCI-E-through-PCI passthrough now?) And it seems to work a lot better! I haven’t gotten any weird NMI entries, and the VM stays snappy.</p> <p>I also found a solution to the problem where the VM wouldn’t show display output after a reboot. Testing with Linux 4.10-rc8, with the command line parameters of <code class="language-plaintext highlighter-rouge">nouveau.config:NvForcePost:1</code> <a href="https://www.phoronix.com/scan.php?page:article&amp;item:nouveau-410-blob&amp;num:1" target="_blank" rel="noopener noreferrer"><code class="language-plaintext highlighter-rouge">nouveau.config:NvBoost:2</code></a>, the problem only seems to arise when the pstate is reclocked to <code class="language-plaintext highlighter-rouge">0f</code> on shutdown. Easy fix—just create a systemd unit to automatically lower the pstate back to the original of <code class="language-plaintext highlighter-rouge">07</code> on shutdown.</p> </article> <hr> <div style="text-align: center;"> <p>If you like reading these posts, get new ones via email:</p> <div id="mc_embed_signup"> <form action="https://kliu.us10.list-manage.com/subscribe/post?u=5539e4dff5ee082eef001e612&amp;id=f9f0fa279e&amp;f_id=000b36e2f0" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate> <div id="mc_embed_signup_scroll"> <div class="mc-field-group" style="margin-bottom: 1em"> <input type="email" value="" name="EMAIL" class="required email" id="mce-EMAIL" required placeholder="email address"> <span id="mce-EMAIL-HELPERTEXT" class="helper_text"></span> <input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="button"> </div> <div id="mce-responses" class="clear foot"> <div class="response" id="mce-error-response" style="display:none"></div> <div class="response" id="mce-success-response" style="display:none; margin-bottom: 1em"></div> </div> <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_5539e4dff5ee082eef001e612_f9f0fa279e" tabindex="-1" value=""></div> <div class="optionalParent"> <div class="clear foot"> </div> </div> </div> </form> </div> <script type="text/javascript" src="//s3.amazonaws.com/downloads.mailchimp.com/js/mc-validate.js"></script> <script type="text/javascript">jQuery,window.fnames=new Array,window.ftypes=new Array,fnames[0]="EMAIL",ftypes[0]="email",fnames[1]="FNAME",ftypes[1]="text",fnames[2]="LNAME",ftypes[2]="text",fnames[3]="ADDRESS",ftypes[3]="address",fnames[4]="PHONE",ftypes[4]="phone",fnames[5]="BIRTHDAY",ftypes[5]="birthday";var $mcj=jQuery.noConflict(!0);</script> </div> <div id="disqus_thread"></div> <script type="text/javascript">var disqus_shortname="kevin-liu",disqus_identifier="/post/vfio-because-i-got-tired-of-rebooting-my-server",disqus_title="VFIO, Because I Got Tired of Rebooting My Server";!function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="//"+disqus_shortname+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)}();</script> <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript" target="_blank" rel="noopener noreferrer">comments powered by Disqus.</a> </noscript> </div> </div> <footer class="sticky-bottom mt-5"> <div class="container"> © 2022 Kevin Liu. Licensed under CC BY-SA 4.0. Last updated: October 23, 2022. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.2/dist/umd/popper.min.js" integrity="sha256-l/1pMF/+J4TThfgARS6KwWrk/egwuVvhRzfLAMQ6Ds4=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.min.js" integrity="sha256-SyTu6CwrfOhaznYZPoolVw2rxoY7lKYKQvqbtqN93HI=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.6/dist/medium-zoom.min.js" integrity="sha256-EdPgYcPk/IIrw7FYeuJQexva49pVRZNmt3LculEr7zM=" crossorigin="anonymous"></script> <script src="/assets/js/zoom.js"></script> <script src="/assets/js/common.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script async src="https://www.googletagmanager.com/gtag/js?id=G-KKF0HL5TKT"></script> <script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-KKF0HL5TKT");</script> </body> </html>